// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

// ===========================================
// DATABASE CONFIGURATION
// ===========================================
// PostgreSQL is the primary database for production and multi-user workloads.
// Update DATABASE_URL in .env to your PostgreSQL connection string:
// DATABASE_URL="postgresql://user:password@localhost:5432/linkflame?schema=public"
//
// PostgreSQL provides:
// - Better concurrency and connection pooling
// - Full-text search (@@fulltext indexes)
// - JSON/JSONB native types (replace String JSON fields)
// - Array types for multi-value fields
// - Row-level security for multi-tenant isolation
//
// NOTE: Currently using SQLite for local development.
// When switching to PostgreSQL, add @db.Decimal(10, 2) to all Decimal fields
// and change provider to "postgresql".
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User and Authentication
// Using NextAuth with JWT strategy (no database sessions needed)
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String? // Used for credentials provider
  role          String    @default("USER")

  // Loyalty program fields
  loyaltyTier         String @default("SEEDLING") // SEEDLING, SPROUT, BLOOM, FLOURISH
  totalLifetimePoints Int    @default(0)

  // Referral program fields
  referralCode String? @unique // User's own referral code

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Multi-tenant organization memberships
  memberships OrganizationMember[]

  Profile            Profile?
  reviews            Review[]
  userImpacts        UserImpact[]
  loyaltyPoints      LoyaltyPoints[]
  loyaltyRedemptions LoyaltyRedemption[]
  referralCodes      ReferralCode[]
  referralsGiven     Referral[]          @relation("Referrer")
  referralReceived   Referral?           @relation("Referee")
  subscriptions      Subscription[]

  @@index([email])
  @@index([referralCode])
}

model Product {
  id          String   @id @default(cuid())
  title       String
  description String?
  price       Decimal
  salePrice   Decimal?
  image       String
  category    String   @default("Uncategorized")
  inventory   Int      @default(0)
  subtitle    String?
  featured    Boolean  @default(false)
  hasVariants Boolean  @default(false) // Whether this product has variant options

  // Brand relationship
  brandId String? // Optional link to brand
  brand   Brand?  @relation(fields: [brandId], references: [id])

  // Sustainability fields
  isPlasticFree        Boolean @default(false)
  isVegan              Boolean @default(false)
  isCrueltyFree        Boolean @default(false)
  isOrganicCertified   Boolean @default(false)
  carbonFootprintGrams Int? // Carbon footprint in grams CO2e

  // Imperfect/Seconds sale fields
  isImperfect       Boolean @default(false)
  imperfectReason   String? // e.g., "Packaging damage", "Minor cosmetic flaw"
  imperfectDiscount Int? // Discount percentage for imperfect items (1-90%)

  // Subscription eligibility
  isSubscribable Boolean @default(false)

  reviews           Review[]
  variants          ProductVariant[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  savedItems        SavedItem[]
  certifications    ProductCertification[]
  productImpacts    ProductImpact[]
  imperfectBatches  ImperfectBatch[]
  bundleProducts    BundleProduct[]
  subscriptionItems SubscriptionItem[]
  values            ProductValueAssignment[]
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt

  @@index([category])
  @@index([category, featured])
  @@index([featured])
  @@index([createdAt(sort: Desc)])
  @@index([isPlasticFree])
  @@index([isVegan])
  @@index([isCrueltyFree])
  @@index([isOrganicCertified])
  @@index([isImperfect])
  @@index([isSubscribable])
  @@index([brandId])
}

// Product variants for size, color, material options
model ProductVariant {
  id        String  @id @default(cuid())
  productId String
  sku       String? // Stock Keeping Unit for this variant
  size      String? // e.g., "S", "M", "L", "XL"
  color     String? // e.g., "Red", "Blue", "Green"
  colorCode String? // Hex color code for UI display, e.g., "#FF0000"
  material  String? // e.g., "Cotton", "Bamboo", "Organic Cotton"
  price     Decimal? // Override price (if null, uses product.price)
  salePrice Decimal? // Override sale price
  image     String? // Override image (for color-specific photos)
  inventory Int     @default(0)
  isDefault Boolean @default(false) // Mark one variant as default selection
  sortOrder Int     @default(0) // For controlling display order

  // Imperfect/Seconds sale fields for variant-level imperfections
  isImperfect       Boolean @default(false)
  imperfectReason   String?
  imperfectDiscount Int?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product           Product            @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems         CartItem[]
  orderItems        OrderItem[]
  subscriptionItems SubscriptionItem[]

  @@unique([productId, sku])
  @@index([productId])
  @@index([productId, isDefault])
  @@index([productId, sortOrder])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  userId    String
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([productId, createdAt(sort: Desc)])
}

model Profile {
  id     String  @id @default(cuid())
  bio    String?
  userId String  @unique
  user   User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CartItem {
  id        String          @id @default(cuid())
  userId    String
  productId String
  variantId String? // Optional: if product has variants, this specifies which one
  quantity  Int
  product   Product         @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  @@unique([userId, productId, variantId]) // Prevent duplicate cart items for same variant
  @@index([userId])
  @@index([productId])
  @@index([variantId])
}

model SavedItem {
  id         String   @id @default(cuid())
  userId     String // Can be authenticated user ID or guest session ID
  productId  String
  wishlistId String? // Optional: belongs to a specific wishlist
  note       String? // User note about why they saved this item
  addedAt    DateTime @default(now())
  savedAt    DateTime @default(now())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  product  Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  wishlist Wishlist? @relation(fields: [wishlistId], references: [id], onDelete: Cascade)

  @@unique([userId, productId, wishlistId]) // Prevent duplicate saves in same wishlist
  @@index([userId])
  @@index([productId])
  @@index([wishlistId])
  @@index([userId, savedAt(sort: Desc)])
  @@index([userId, addedAt(sort: Desc)])
}

// Wishlist for organizing saved items
model Wishlist {
  id         String   @id @default(cuid())
  visibleId  String   @unique // User-facing ID (e.g., wl_abc123)
  userId     String // Owner of the wishlist
  name       String // e.g., "Favorites", "Gift Ideas", "Kitchen Essentials"
  isDefault  Boolean  @default(false) // Default wishlist for user
  isPublic   Boolean  @default(false) // Whether this wishlist can be shared
  shareToken String?  @unique // Token for sharing public wishlists
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  items SavedItem[]

  @@index([userId])
  @@index([userId, isDefault])
  @@index([shareToken])
}

model Category {
  id        String     @id @default(cuid())
  name      String
  blogPosts BlogPost[]
}

model BlogPost {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  content     String?
  coverImage  String?
  publishedAt DateTime @default(now())
  authorId    String
  categoryId  String?
  tags        String?
  featured    Boolean  @default(false)
  readingTime String?

  author   Author    @relation(fields: [authorId], references: [id])
  category Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([featured])
  @@index([publishedAt(sort: Desc)])
  @@index([categoryId])
  @@index([categoryId, publishedAt(sort: Desc)])
  @@index([featured, publishedAt(sort: Desc)]) // Optimizes featured posts query
}

model Author {
  id        String     @id @default(cuid())
  name      String
  image     String?
  role      String?
  blogPosts BlogPost[]
}

model Order {
  id              String  @id @default(cuid())
  userId          String
  stripeSessionId String? @unique
  amount          Decimal
  status          String // Payment status: paid, pending, failed, refunded
  shippingAddress String?
  paymentMethod   String?
  customerEmail   String?
  customerName    String?

  // Shipping tracking fields
  shippingStatus    String?   @default("processing") // processing, shipped, in_transit, out_for_delivery, delivered, cancelled
  trackingNumber    String?
  shippingCarrier   String? // UPS, USPS, FedEx, DHL, etc.
  estimatedDelivery DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?

  // Gift options
  isGift             Boolean @default(false)
  giftMessage        String? // Max 500 characters
  giftRecipientName  String?
  giftRecipientEmail String?
  hidePrice          Boolean @default(false) // Hide price on packing slip

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  items        OrderItem[]
  carbonOffset CarbonOffset?
  orderImpacts OrderImpact[]

  @@index([userId])
  @@index([stripeSessionId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([shippingStatus])
  @@index([isGift])
}

model OrderItem {
  id              String          @id @default(cuid())
  orderId         String
  productId       String
  variantId       String? // Reference to variant if applicable
  quantity        Int
  price           Decimal
  title           String
  // Store variant details at time of order (denormalized for historical accuracy)
  variantSku      String?
  variantSize     String?
  variantColor    String?
  variantMaterial String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  order           Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product         Product         @relation(fields: [productId], references: [id])
  variant         ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model Newsletter {
  id           String   @id @default(cuid())
  email        String   @unique
  subscribedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}

model Contact {
  id          String   @id @default(cuid())
  name        String
  email       String
  subject     String
  message     String
  submittedAt DateTime @default(now())
  status      String   @default("new")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([submittedAt])
}

// Sustainability Certification Models
// Represents certifications like B Corp, 1% for Planet, etc.
model SustainabilityCertification {
  id              String   @id @default(cuid())
  name            String   @unique // e.g., "B Corp Certified", "1% for the Planet"
  description     String? // Detailed description of what this certification means
  iconUrl         String? // URL to the certification badge/icon image
  verificationUrl String? // URL where customers can verify the certification
  sortOrder       Int      @default(0) // For controlling display order
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  products ProductCertification[]

  @@index([isActive])
  @@index([sortOrder])
}

// Junction table for Product-Certification many-to-many relationship
model ProductCertification {
  id                String    @id @default(cuid())
  productId         String
  certificationId   String
  verifiedAt        DateTime  @default(now()) // When this certification was verified for this product
  expiresAt         DateTime? // Optional expiration date
  certificateNumber String? // Optional certification number/ID
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  product       Product                     @relation(fields: [productId], references: [id], onDelete: Cascade)
  certification SustainabilityCertification @relation(fields: [certificationId], references: [id], onDelete: Cascade)

  @@unique([productId, certificationId]) // Prevent duplicate certifications per product
  @@index([productId])
  @@index([certificationId])
}

// Carbon Offset tracking for orders
model CarbonOffset {
  id             String   @id @default(cuid())
  orderId        String   @unique
  offsetAmountKg Float // Amount of CO2 offset in kilograms
  provider       String? // Carbon offset provider (e.g., "Pachama", "Gold Standard")
  certificateUrl String? // URL to the offset certificate
  projectName    String? // Name of the offset project
  purchasedAt    DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([provider])
  @@index([purchasedAt(sort: Desc)])
}

// Environmental Impact Tracking Models

// Defines types of environmental impact metrics (e.g., plastic saved, carbon offset)
model ImpactMetric {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  unit        String
  iconName    String
  description String?
  comparison  String?
  sortOrder   Int      @default(0)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  productImpacts ProductImpact[]
  userImpacts    UserImpact[]
  orderImpacts   OrderImpact[]

  @@index([isActive, sortOrder])
  @@index([slug])
}

// Links products to their environmental impact values
model ProductImpact {
  id           String   @id @default(cuid())
  productId    String
  metricId     String
  valuePerUnit Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  metric  ImpactMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@unique([productId, metricId])
  @@index([productId])
  @@index([metricId])
}

// Aggregated user impact totals for each metric
model UserImpact {
  id            String   @id @default(cuid())
  userId        String
  metricId      String
  totalValue    Float    @default(0)
  lastUpdatedAt DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user   User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  metric ImpactMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@unique([userId, metricId])
  @@index([userId])
  @@index([metricId])
}

// Impact values calculated for each order
model OrderImpact {
  id        String   @id @default(cuid())
  orderId   String
  metricId  String
  value     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  order  Order        @relation(fields: [orderId], references: [id], onDelete: Cascade)
  metric ImpactMetric @relation(fields: [metricId], references: [id], onDelete: Cascade)

  @@unique([orderId, metricId])
  @@index([orderId])
  @@index([metricId])
}

// ===========================================
// PRODUCT BUNDLES
// ===========================================

// Bundle: A curated collection of products sold together at a discount
model Bundle {
  id              String   @id @default(cuid())
  slug            String   @unique
  title           String // Display name of the bundle
  description     String?
  image           String?
  category        String?
  discountPercent Float    @default(10) // Percentage discount for the bundle
  isActive        Boolean  @default(true)
  isCustomizable  Boolean  @default(false) // Whether users can customize the bundle
  minItems        Int? // Minimum items required (null = no minimum)
  maxItems        Int? // Maximum items allowed (null = unlimited)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  products   BundleProduct[]
  selections BundleSelection[]

  @@index([isActive])
  @@index([category])
  @@index([slug])
}

// Junction table for Bundle-Product relationship
model BundleProduct {
  id          String   @id @default(cuid())
  bundleId    String
  productId   String
  isRequired  Boolean  @default(false) // Whether this product must be in the bundle
  isDefault   Boolean  @default(false) // Whether this product is selected by default
  maxQuantity Int      @default(1) // Maximum quantity of this product in bundle
  sortOrder   Int      @default(0) // Display order within bundle
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  bundle  Bundle  @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([bundleId, productId])
  @@index([bundleId])
  @@index([productId])
}

// User's customized bundle selection
model BundleSelection {
  id              String   @id @default(cuid())
  bundleId        String
  userId          String? // Authenticated user ID (optional for guests)
  sessionId       String? // Guest session ID (optional for logged-in users)
  selectedItems   String // JSON array of selected items with details
  totalPrice      Decimal
  discountedPrice Decimal  @default(0)
  savings         Decimal  @default(0)
  status          String   @default("pending") // pending, in_cart, purchased
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  bundle Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)

  @@index([bundleId])
  @@index([userId])
  @@index([sessionId])
}

// ===========================================
// IMPERFECT/SECONDS SALE
// ===========================================

// Batch of imperfect items with specific reason and discount
model ImperfectBatch {
  id              String    @id @default(cuid())
  productId       String
  quantity        Int       @default(0) // Available imperfect quantity
  reason          String // Reason for imperfection
  discountPercent Int // Discount percentage for this batch
  isActive        Boolean   @default(true)
  expiresAt       DateTime? // Optional expiration for the batch
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([isActive])
  @@index([productId, isActive])
}

// ===========================================
// QUIZ SYSTEM
// ===========================================

// Quiz questions for product recommendations
model QuizQuestion {
  id             String   @id @default(cuid())
  visibleId      String   @unique // User-facing ID (e.g., q1, q2)
  question       String // The question text
  questionType   String // SINGLE_CHOICE or MULTIPLE_CHOICE
  options        String // JSON array of QuizOption objects
  categoryFilter String? // Filter to specific category if applicable
  orderIndex     Int      @default(0) // Display order
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([isActive, orderIndex])
}

// User quiz responses and recommendations
model QuizResponse {
  id                    String   @id @default(cuid())
  visibleId             String   @unique // User-facing ID (e.g., quiz_abc123)
  sessionId             String? // Guest session ID
  userId                String? // Authenticated user ID (if logged in)
  responses             String // JSON object of question answers
  recommendedProductIds String // JSON array of recommended product IDs
  completedAt           DateTime @default(now()) // When the quiz was completed
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([sessionId])
  @@index([userId])
  @@index([visibleId])
}

// Product values for quiz matching (e.g., eco-friendly, vegan)
model ProductValue {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "plastic-free", "vegan"
  slug        String   @unique // URL-friendly identifier
  label       String // Display label
  description String?
  iconName    String? // Icon name for display
  sortOrder   Int      @default(0) // Display order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products ProductValueAssignment[]

  @@index([sortOrder])
}

// Junction table for Product-Value relationship
model ProductValueAssignment {
  id        String   @id @default(cuid())
  productId String
  valueId   String
  strength  Float    @default(1.0) // How strongly this product matches the value (0-1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  product Product      @relation(fields: [productId], references: [id], onDelete: Cascade)
  value   ProductValue @relation(fields: [valueId], references: [id], onDelete: Cascade)

  @@unique([productId, valueId])
  @@index([productId])
  @@index([valueId])
}

// ===========================================
// SUBSCRIPTIONS (SUBSCRIBE & SAVE)
// ===========================================

// Subscription: Recurring delivery of products
model Subscription {
  id               String    @id @default(cuid())
  visibleId        String    @unique // User-facing ID (e.g., SUB-ABC123)
  userId           String
  status           String    @default("ACTIVE") // ACTIVE, PAUSED, CANCELLED
  frequency        String // WEEKLY, BIWEEKLY, MONTHLY, BIMONTHLY
  nextDeliveryDate DateTime
  lastDeliveryDate DateTime?
  skipNextDelivery Boolean   @default(false) // Whether to skip the next delivery
  pausedAt         DateTime?
  cancelledAt      DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  user   User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  items  SubscriptionItem[]
  pauses SubscriptionPause[]

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([nextDeliveryDate])
}

// Individual items within a subscription
model SubscriptionItem {
  id                  String   @id @default(cuid())
  subscriptionId      String
  productId           String
  variantId           String?
  quantity            Int      @default(1)
  priceAtSubscription Decimal // Price locked in at subscription time
  discountPercent     Float    @default(0) // Discount applied to this item
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  subscription Subscription    @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  product      Product         @relation(fields: [productId], references: [id])
  variant      ProductVariant? @relation(fields: [variantId], references: [id])

  @@unique([subscriptionId, productId, variantId])
  @@index([subscriptionId])
  @@index([productId])
  @@index([variantId])
}

// Track subscription pauses
model SubscriptionPause {
  id             String    @id @default(cuid())
  subscriptionId String
  pausedAt       DateTime  @default(now())
  resumeAt       DateTime? // Scheduled resume date (null = indefinite pause)
  resumedAt      DateTime? // Actual resume date
  reason         String? // Reason for pausing
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([subscriptionId, resumedAt])
}

// ===========================================
// BRAND DIRECTORY
// ===========================================

// Brand: Eco-friendly partner brand
model Brand {
  id             String   @id @default(cuid())
  slug           String   @unique // URL-friendly identifier
  name           String // Brand name
  description    String? // Brief description
  logo           String? // URL to brand logo
  website        String? // Brand website URL
  story          String? // Full brand story (longer content)
  foundedYear    Int? // Year the brand was founded
  headquarters   String? // Brand headquarters location
  certifications String? // JSON array of certification slugs
  values         String? // JSON array of value slugs (Women-Owned, BIPOC-Owned, etc.)
  featured       Boolean  @default(false) // Featured on homepage
  isActive       Boolean  @default(true) // Whether brand is visible
  sortOrder      Int      @default(0) // For controlling display order
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  products Product[]

  @@index([slug])
  @@index([featured])
  @@index([isActive])
  @@index([isActive, sortOrder])
  @@index([isActive, featured])
}

// ===========================================
// LOYALTY PROGRAM
// ===========================================

// Tracks loyalty points earned by users
model LoyaltyPoints {
  id          String    @id @default(cuid())
  userId      String
  points      Int // Points earned (positive number)
  source      String // PURCHASE, REVIEW, REFERRAL, SIGNUP
  orderId     String? // Reference to order if earned from purchase
  reviewId    String? // Reference to review if earned from review
  referralId  String? // Reference to referral if earned from referral
  description String? // Human-readable description
  expiresAt   DateTime? // Optional expiration date
  earnedAt    DateTime  @default(now()) // When the points were earned
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, expiresAt])
  @@index([source])
  @@index([orderId])
  @@index([earnedAt])
}

// Tracks loyalty point redemptions
model LoyaltyRedemption {
  id             String   @id @default(cuid())
  userId         String
  pointsUsed     Int // Points redeemed
  orderId        String? // Order where redemption was applied
  discount       Decimal // Dollar amount discounted
  discountAmount Decimal  @default(0) // Alias for discount amount
  status         String   @default("applied") // applied, refunded
  redeemedAt     DateTime @default(now()) // When the points were redeemed
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([orderId])
  @@index([status])
  @@index([redeemedAt])
}

// ===========================================
// REFERRAL PROGRAM
// ===========================================

// User's referral code(s) for sharing
model ReferralCode {
  id              String   @id @default(cuid())
  code            String   @unique // The actual referral code (e.g., ECO-ABC123)
  ownerId         String // User who owns this code
  discountPercent Int      @default(10) // Discount for referee
  isActive        Boolean  @default(true)
  usageLimit      Int? // Maximum number of uses (null = unlimited)
  usageCount      Int      @default(0) // Current usage count
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  owner     User       @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  referrals Referral[]

  @@index([code])
  @@index([ownerId])
  @@index([isActive])
}

// Tracks individual referrals
model Referral {
  id              String    @id @default(cuid())
  referrerId      String // User who made the referral
  refereeId       String    @unique // User who was referred (one referral per user)
  referralCodeId  String // The referral code used
  status          String    @default("PENDING") // PENDING, COMPLETED, REWARDED, EXPIRED
  discountApplied Decimal? // Discount applied to referee's first order
  pointsAwarded   Int? // Points awarded to referrer
  rewardPoints    Int       @default(0) // Points to be awarded to referrer (alias)
  firstOrderId    String? // Referee's first order that triggered completion
  refereeOrderId  String? // Alias for first order ID
  completedAt     DateTime? // When referral was completed
  rewardedAt      DateTime? // When referrer was rewarded
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  referrer     User         @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referee      User         @relation("Referee", fields: [refereeId], references: [id], onDelete: Cascade)
  referralCode ReferralCode @relation(fields: [referralCodeId], references: [id], onDelete: Cascade)

  @@index([referrerId])
  @@index([refereeId])
  @@index([referralCodeId])
  @@index([status])
}

// ===========================================
// GIFT CARDS
// ===========================================

// Gift card for purchasing and gifting store credit
model GiftCard {
  id             String    @id @default(cuid())
  code           String    @unique // 16-character alphanumeric code
  initialBalance Decimal // Original amount of the gift card
  currentBalance Decimal // Remaining balance
  purchaserId    String? // User who purchased the gift card (optional for guest purchases)
  recipientEmail String? // Email address of the recipient
  recipientName  String? // Name of the recipient
  message        String? // Personal message from purchaser
  status         String    @default("ACTIVE") // ACTIVE, REDEEMED, EXPIRED, CANCELLED
  expiresAt      DateTime? // Optional expiration date
  purchasedAt    DateTime  @default(now())
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  transactions GiftCardTransaction[]

  @@index([code])
  @@index([purchaserId])
  @@index([recipientEmail])
  @@index([status])
  @@index([expiresAt])
}

// Transaction history for gift card usage
model GiftCardTransaction {
  id          String   @id @default(cuid())
  giftCardId  String
  orderId     String? // Reference to order if used in checkout
  amount      Decimal // Transaction amount (positive for purchase, negative for redemption)
  type        String // PURCHASE, REDEMPTION, REFUND
  description String? // Optional description of the transaction
  createdAt   DateTime @default(now())

  giftCard GiftCard @relation(fields: [giftCardId], references: [id], onDelete: Cascade)

  @@index([giftCardId])
  @@index([orderId])
  @@index([type])
  @@index([createdAt(sort: Desc)])
}

// ===========================================
// TERRACYCLE RECYCLING PROGRAM
// ===========================================

// Tracks customer TerraCycle shipments for recycling packaging
model TerraCycleSubmission {
  id        String @id @default(cuid())
  visibleId String @unique // User-facing ID (e.g., TC-ABC123)
  userId    String // User who made the submission
  status    String @default("PENDING") // PENDING, LABEL_SENT, SHIPPED, RECEIVED, PROCESSED
  itemCount Int? // Estimated number of items in the shipment
  weightKg  Float? // Weight of the shipment in kg (filled after processing)

  // Shipping information
  shippingLabelUrl String? // URL to the prepaid shipping label
  trackingNumber   String? // Shipping tracking number
  carrier          String? // Shipping carrier (USPS, UPS, FedEx, etc.)

  // Processing information
  processedAt       DateTime? // When TerraCycle processed the shipment
  materialsRecycled String? // JSON array of materials recycled
  impactMetrics     String? // JSON object of impact metrics (plastic saved, CO2 offset, etc.)

  // Rewards
  pointsAwarded   Int       @default(0) // Loyalty points awarded for this submission
  pointsAwardedAt DateTime? // When points were awarded

  // User notes
  notes String? // User notes about the shipment

  labelRequestedAt DateTime  @default(now()) // When the shipping label was requested
  shippedAt        DateTime? // When the user shipped the package
  receivedAt       DateTime? // When TerraCycle received the package
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([userId, status])
  @@index([visibleId])
  @@index([trackingNumber])
  @@index([labelRequestedAt(sort: Desc)])
}

// Tracks aggregate TerraCycle statistics for users
model TerraCycleStats {
  id                 String    @id @default(cuid())
  userId             String    @unique // One stats record per user
  totalSubmissions   Int       @default(0) // Total number of submissions
  totalItemsRecycled Int       @default(0) // Total items recycled
  totalWeightKg      Float     @default(0) // Total weight recycled in kg
  totalPointsEarned  Int       @default(0) // Total points earned from recycling
  plasticSavedKg     Float     @default(0) // Plastic diverted from landfills
  co2SavedKg         Float     @default(0) // CO2 emissions prevented
  waterSavedLiters   Float     @default(0) // Water saved through recycling
  lastSubmissionAt   DateTime? // Date of most recent submission
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([userId])
  @@index([totalItemsRecycled(sort: Desc)])
  @@index([totalWeightKg(sort: Desc)])
}

// ===========================================
// MULTI-TENANT TEAM MANAGEMENT
// ===========================================

// Organization: Represents a tenant/company in the SaaS platform
model Organization {
  id               String    @id @default(cuid())
  name             String
  slug             String    @unique // URL-friendly identifier (e.g., "acme-corp")
  customDomain     String?   @unique // Custom domain for white-labeling (e.g., "shop.acme.com")
  logo             String? // URL to organization logo
  settings         String? // JSON for org settings (theme, features, limits)

  // Stripe Billing Integration
  stripeCustomerId     String?   @unique // Stripe customer ID for billing
  stripeSubscriptionId String?   @unique // Active Stripe subscription ID
  plan                 String    @default("FREE") // FREE, STARTER, PRO, ENTERPRISE
  billingInterval      String?   // monthly, yearly (null for free plan)
  subscriptionStatus   String    @default("active") // active, canceled, past_due, trialing, etc.
  trialEndsAt          DateTime? // Trial end date (null if not on trial)
  currentPeriodStart   DateTime? // Start of current billing period
  currentPeriodEnd     DateTime? // End of current billing period
  canceledAt           DateTime? // When subscription was canceled (for cancel_at_period_end)

  // Billing Contact
  billingEmail   String? // Email for billing notifications (defaults to owner email)
  billingName    String? // Billing contact name
  billingAddress String? // JSON for billing address

  // Usage & Limits Tracking
  usageResetAt     DateTime? // When usage counters were last reset
  paymentFailedAt  DateTime? // Track payment failures for grace period

  // Plan limits (denormalized for quick access, synced from plan)
  limitProducts    Int @default(10)
  limitOrders      Int @default(50)
  limitTeamMembers Int @default(1)
  limitStorageMB   Int @default(100)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members          OrganizationMember[]
  invitations      OrganizationInvitation[]
  subscriptions    OrganizationSubscription[]
  billingEvents    BillingEvent[]

  @@index([slug])
  @@index([plan])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
  @@index([subscriptionStatus])
}

// OrganizationSubscription: Historical record of subscription changes
model OrganizationSubscription {
  id                   String    @id @default(cuid())
  organizationId       String
  stripeSubscriptionId String
  stripePriceId        String
  planId               String    // FREE, STARTER, PRO, ENTERPRISE
  billingInterval      String    // monthly, yearly
  status               String    // active, canceled, past_due, trialing, etc.
  amount               Decimal // Amount in dollars
  currency             String    @default("usd")
  trialStart           DateTime?
  trialEnd             DateTime?
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  canceledAt           DateTime?
  endedAt              DateTime?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
}

// BillingEvent: Audit trail for all billing-related events
model BillingEvent {
  id              String   @id @default(cuid())
  organizationId  String
  stripeEventId   String   @unique // Stripe event ID for idempotency
  eventType       String   // invoice.paid, subscription.updated, etc.
  eventData       String   // JSON payload from Stripe
  processedAt     DateTime @default(now())
  processingError String?  // Error message if processing failed

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([stripeEventId])
  @@index([eventType])
  @@index([processedAt(sort: Desc)])
}

// OrganizationMember: Links users to organizations with roles
model OrganizationMember {
  id             String   @id @default(cuid())
  organizationId String
  userId         String
  role           String   @default("MEMBER") // OWNER, ADMIN, MEMBER, VIEWER
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId]) // User can only have one membership per org
  @@index([organizationId])
  @@index([userId])
}

// OrganizationInvitation: Pending invitations to join an organization
model OrganizationInvitation {
  id             String    @id @default(cuid())
  organizationId String
  email          String // Email of the invited person
  role           String    @default("MEMBER") // Role to assign when accepted
  token          String    @unique // Secure invitation token
  expiresAt      DateTime // When the invitation expires
  acceptedAt     DateTime? // When the invitation was accepted (null = pending)
  invitedById    String // User who sent the invitation
  createdAt      DateTime  @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@unique([organizationId, email]) // Only one pending invite per email per org
  @@index([token])
  @@index([expiresAt])
}

// AuditLog: Compliance and security audit trail
model AuditLog {
  id             String   @id @default(cuid())
  organizationId String? // Organization context (null for system-wide events)
  userId         String? // User who performed the action (null for system events)
  action         String // Action performed (e.g., "user.created", "order.updated")
  entityType     String // Type of entity affected (e.g., "User", "Order", "Product")
  entityId       String? // ID of the affected entity
  changes        String? // JSON object describing the changes (before/after)
  ipAddress      String? // IP address of the request
  userAgent      String? // User agent string of the request
  createdAt      DateTime @default(now())

  @@index([organizationId])
  @@index([userId])
  @@index([entityType, entityId])
  @@index([createdAt(sort: Desc)])
}

// ApiKey: Programmatic access tokens for API integrations
model ApiKey {
  id             String    @id @default(cuid())
  organizationId String // Organization this key belongs to
  name           String // Human-readable name for the key
  keyHash        String    @unique // SHA-256 hash of the actual key (never store plaintext)
  keyPrefix      String // First 8 chars of the key for identification (e.g., "lf_live_")
  scopes         String // JSON array of permission scopes (e.g., ["products:read", "orders:write"])
  lastUsedAt     DateTime? // Last time the key was used
  expiresAt      DateTime? // Optional expiration date (null = never expires)
  revokedAt      DateTime? // When the key was revoked (null = active)
  createdById    String // User who created this API key
  createdAt      DateTime  @default(now())

  @@index([organizationId])
  @@index([keyPrefix])
}
