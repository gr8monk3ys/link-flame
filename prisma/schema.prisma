// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User and Authentication
// Using NextAuth with JWT strategy (no database sessions needed)
model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  image         String?
  password      String?   // Used for credentials provider
  role          String    @default("USER")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  Profile       Profile?
  reviews       Review[]

  @@index([email])
}

model Product {
  id          String      @id @default(cuid())
  title       String
  description String?
  price       Float
  salePrice   Float?
  image       String
  category    String      @default("Uncategorized")
  inventory   Int         @default(0)
  subtitle    String?
  featured    Boolean     @default(false)
  hasVariants Boolean     @default(false) // Whether this product has variant options
  reviews     Review[]
  variants    ProductVariant[]
  cartItems   CartItem[]
  orderItems  OrderItem[]
  savedItems  SavedItem[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([category])
  @@index([category, featured])
  @@index([featured])
  @@index([createdAt(sort: Desc)])
}

// Product variants for size, color, material options
model ProductVariant {
  id          String    @id @default(cuid())
  productId   String
  sku         String?   // Stock Keeping Unit for this variant
  size        String?   // e.g., "S", "M", "L", "XL"
  color       String?   // e.g., "Red", "Blue", "Green"
  colorCode   String?   // Hex color code for UI display, e.g., "#FF0000"
  material    String?   // e.g., "Cotton", "Bamboo", "Organic Cotton"
  price       Float?    // Override price (if null, uses product.price)
  salePrice   Float?    // Override sale price
  image       String?   // Override image (for color-specific photos)
  inventory   Int       @default(0)
  isDefault   Boolean   @default(false) // Mark one variant as default selection
  sortOrder   Int       @default(0)     // For controlling display order
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  product     Product    @relation(fields: [productId], references: [id], onDelete: Cascade)
  cartItems   CartItem[]
  orderItems  OrderItem[]

  @@unique([productId, sku])
  @@index([productId])
  @@index([productId, isDefault])
  @@index([productId, sortOrder])
}

model Review {
  id        String   @id @default(cuid())
  rating    Int
  comment   String?
  userId    String
  productId String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([userId])
  @@index([productId, createdAt(sort: Desc)])
}

model Profile {
  id     String @id @default(cuid())
  bio    String?
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CartItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  variantId String?  // Optional: if product has variants, this specifies which one
  quantity  Int
  product   Product  @relation(fields: [productId], references: [id])
  variant   ProductVariant? @relation(fields: [variantId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId, variantId]) // Prevent duplicate cart items for same variant
  @@index([userId])
  @@index([productId])
  @@index([variantId])
}

model SavedItem {
  id        String   @id @default(cuid())
  userId    String   // Can be authenticated user ID or guest session ID
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  savedAt   DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId]) // Prevent duplicate saves
  @@index([userId])
  @@index([productId])
  @@index([userId, savedAt(sort: Desc)])
}

model Category {
  id        String     @id @default(cuid())
  name      String
  blogPosts BlogPost[]
}

model BlogPost {
  id          String   @id @default(cuid())
  slug        String   @unique
  title       String
  description String?
  content     String?
  coverImage  String?
  publishedAt DateTime @default(now())
  authorId    String
  categoryId  String?
  tags        String?
  featured    Boolean  @default(false)
  readingTime String?

  author     Author     @relation(fields: [authorId], references: [id])
  category   Category?  @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([slug])
  @@index([featured])
  @@index([publishedAt(sort: Desc)])
  @@index([categoryId])
  @@index([categoryId, publishedAt(sort: Desc)])
}

model Author {
  id          String   @id @default(cuid())
  name        String
  image       String?
  role        String?
  blogPosts BlogPost[]
}

model Order {
  id              String      @id @default(cuid())
  userId          String
  stripeSessionId String?     @unique
  amount          Float
  status          String      // Payment status: paid, pending, failed, refunded
  shippingAddress String?
  paymentMethod   String?
  customerEmail   String?
  customerName    String?

  // Shipping tracking fields
  shippingStatus    String?   @default("processing") // processing, shipped, in_transit, out_for_delivery, delivered, cancelled
  trackingNumber    String?
  shippingCarrier   String?   // UPS, USPS, FedEx, DHL, etc.
  estimatedDelivery DateTime?
  shippedAt         DateTime?
  deliveredAt       DateTime?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  items           OrderItem[]

  @@index([userId])
  @@index([stripeSessionId])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([shippingStatus])
}

model OrderItem {
  id         String   @id @default(cuid())
  orderId    String
  productId  String
  variantId  String?  // Reference to variant if applicable
  quantity   Int
  price      Float
  title      String
  // Store variant details at time of order (denormalized for historical accuracy)
  variantSku     String?
  variantSize    String?
  variantColor   String?
  variantMaterial String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  order      Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product    Product  @relation(fields: [productId], references: [id])
  variant    ProductVariant? @relation(fields: [variantId], references: [id])

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
}

model Newsletter {
  id           String   @id @default(cuid())
  email        String   @unique
  subscribedAt DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([email])
}

model Contact {
  id          String   @id @default(cuid())
  name        String
  email       String
  subject     String
  message     String
  submittedAt DateTime @default(now())
  status      String   @default("new")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([submittedAt])
}
